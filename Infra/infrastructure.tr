terraform {
  required_version = ">= 1.5"

  required_providers {
    hcloud = {
      source  = "hetznercloud/hcloud"
      version = "~> 1.45"
    }
    azurerm = {
      source  = "hashicorp/azurerm"
      version = "~> 3.100"
    }
  }
}

variable "hcloud_token" {
  type        = string
  sensitive   = true
}

variable "hcloud_ssh_key_name" {
  type = string
}

provider "hcloud" {
  token = var.hcloud_token
}

provider "azurerm" {
  features {}
}

resource "hcloud_server" "app_server" {
  name        = "fasttrack-app"
  image       = "ubuntu-22.04"
  server_type = "cx31"
  location    = "nbg1"

  ssh_keys = [var.hcloud_ssh_key_name]

  user_data = <<-EOF
    #!/bin/bash
    apt-get update -y
    apt-get install -y docker.io docker-compose-plugin
    systemctl enable docker
    systemctl start docker
  EOF
}

resource "azurerm_resource_group" "ai_rg" {
  name     = "fasttrack-ai-rg"
  location = "West Europe"
}

resource "azurerm_cognitive_account" "openai" {
  name                = "fasttrack-openai-demo"
  location            = azurerm_resource_group.ai_rg.location
  resource_group_name = azurerm_resource_group.ai_rg.name

  kind     = "OpenAI"
  sku_name = "S0"
}

output "hetzner_server_ipv4" {
  value = hcloud_server.app_server.ipv4_address
}

output "azure_openai_endpoint" {
  value = azurerm_cognitive_account.openai.endpoint
}
